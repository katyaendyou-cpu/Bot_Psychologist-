# -*- coding: utf-8 -*-
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import Application, MessageHandler, ContextTypes, filters
from telegram.constants import ParseMode
import random

# Клавиатура для подкатегории «Слёзы»
TEARS_FLOW_KB = ReplyKeyboardMarkup(
    [["Ещё про слёзы", "Назад"]],
    resize_keyboard=True
)

# 20 техник для «Слёзы»
TECHNIQUES_SLEZY = [
    {
        "title": "Тёплое полотенце",
        "why": "Снимает спазм и расслабляет мышцы лица.",
        "steps": [
            "Намочи полотенце тёплой водой.",
            "Приложи к глазам и скулам на 1–2 минуты.",
            "Сделай 5 глубоких вдохов."
        ],
        "pep": "Слёзы не делают тебя слабой — они помогают отпускать."
    },
    {
        "title": "Слёзы у окна",
        "why": "Даёт опору, пока слёзы выходят.",
        "steps": [
            "Встань у окна, обопрись руками о подоконник.",
            "Позволь слезам течь, глядя на небо или улицу.",
            "Дыши глубоко до ощущения облегчения."
        ],
        "pep": "То, что выходит слезами, не будет лежать камнем внутри."
    },
    {
        "title": "Обнять подушку",
        "why": "Дает телу ощущение поддержки, когда рядом никого нет.",
        "steps": [
            "Возьми большую подушку.",
            "Обними её изо всех сил, уткнись лицом.",
            "Скажи вслух: «Я выдержу»."
        ],
        "pep": "Ты держишься лучше, чем думаешь."
    },
    {
        "title": "Маленькие глотки воды",
        "why": "Замедляет дыхание и мягко переключает внимание.",
        "steps": [
            "Налей стакан воды.",
            "Сделай 10 медленных маленьких глотков.",
            "После каждого глотка замечай, как тело успокаивается."
        ],
        "pep": "С каждым глотком возвращается твоё спокойствие."
    },
    {
        "title": "Записать слёзы",
        "why": "Даёт выход эмоциям на бумаге.",
        "steps": [
            "Возьми лист или тетрадь.",
            "Пиши всё, что вызывает слёзы, не редактируя.",
            "Если хочешь отпустить — порви или сожги лист."
        ],
        "pep": "Бумага выдержит всё — а ты уже справляешься."
    },
    {
        "title": "Смена позы",
        "why": "Помогает выйти из застывания тела.",
        "steps": [
            "Если сидишь — встань, если лежишь — сядь.",
            "Потянись вверх и глубоко вдохни.",
            "Выдохни, опуская плечи."
        ],
        "pep": "Твоё тело знает, как помочь сердцу."
    },
    {
        "title": "Кубик льда",
        "why": "Быстро собирает, когда нужно остановить поток.",
        "steps": [
            "Возьми кубик льда в ладонь на 1 минуту.",
            "Проведи им по векам и скулам.",
            "Сделай три медленных вдоха."
        ],
        "pep": "Ты можешь вернуть себе собранность, когда это нужно."
    },
    {
        "title": "Слёзы в душе",
        "why": "Безопасно выплакаться полностью.",
        "steps": [
            "Встань под тёплый душ.",
            "Позволь воде смешаться со слезами.",
            "Постой 5 минут, представляя, что вода смывает тяжесть."
        ],
        "pep": "Вода забирает лишнее и оставляет тебе силу."
    },
    {
        "title": "Музыка тишины",
        "why": "Звук помогает переключить эмоцию.",
        "steps": [
            "Включи спокойную музыку или звуки природы.",
            "Сядь или ляг, закрой глаза.",
            "Дыши в ритме музыки."
        ],
        "pep": "Звук может стать новой опорой."
    },
    {
        "title": "Дыхание в ладони",
        "why": "Возвращает ощущение контроля.",
        "steps": [
            "Сложи ладони чашечкой у лица.",
            "Вдохни в ладони, выдохни в ладони.",
            "Повтори 5–7 раз."
        ],
        "pep": "Ты создаёшь себе маленький остров спокойствия."
    },
    {
        "title": "Тёплый напиток",
        "why": "Успокаивает через тепло и ритуал.",
        "steps": [
            "Сделай чай или подогрей молоко.",
            "Держи кружку двумя руками, почувствуй тепло.",
            "Сделай 10 медленных глотков."
        ],
        "pep": "Тепло возвращает тебе землю под ногами."
    },
    {
        "title": "Погладить плечи",
        "why": "Физическая забота о себе снижает плач.",
        "steps": [
            "Обними себя за плечи.",
            "Погладь ладонями по плечам 1–2 минуты."
        ],
        "pep": "Ты можешь дать себе то, чего ждала от других."
    },
    {
        "title": "Смена пространства",
        "why": "Небольшое перемещение меняет состояние.",
        "steps": [
            "Перейди в другую комнату или выйди на улицу.",
            "Отметь три предмета, на которые смотришь."
        ],
        "pep": "Даже маленькая смена места даёт дыхание."
    },
    {
        "title": "Кокон из одеяла",
        "why": "Создаёт ощущение безопасности.",
        "steps": [
            "Укройся одеялом с головой.",
            "Позволь себе плакать, пока не утихнет."
        ],
        "pep": "Ты имеешь право на своё безопасное пространство."
    },
    {
        "title": "Три предложения",
        "why": "Осознавание чувств даёт опору.",
        "steps": [
            "Напиши: «Я чувствую…», «Потому что…», «Я хочу…».",
            "Прочитай вслух."
        ],
        "pep": "Осознавая чувства, ты возвращаешь себе силу."
    },
    {
        "title": "Холод на запястьях",
        "why": "Резко переключает нервную систему.",
        "steps": [
            "Подержи запястья под холодной водой 30 секунд."
        ],
        "pep": "Ты сильнее, чем кажутся твоим слезам."
    },
    {
        "title": "Счёт дыхания",
        "why": "Стабилизирует эмоцию через ритм.",
        "steps": [
            "Считай вдохи и выдохи: 1 до 10, затем снова с 1."
        ],
        "pep": "Счёт возвращает контроль над моментом."
    },
    {
        "title": "Обнять мягкую вещь",
        "why": "Мягкость снимает напряжение.",
        "steps": [
            "Найди плед или мягкую игрушку.",
            "Обними и подержи на груди 1–2 минуты."
        ],
        "pep": "Мягкость помогает пережить бурю."
    },
    {
        "title": "С вопросом к себе",
        "why": "Делает плач осознанным и лечащим.",
        "steps": [
            "Плачь и задай вопрос: «Что именно я сейчас отпускаю?»",
            "Заметив ответ, сделай глубокий выдох."
        ],
        "pep": "Слёзы становятся началом освобождения."
    },
    {
        "title": "Тишина на 5 минут",
        "why": "Даёт плачу естественно стихнуть.",
        "steps": [
            "Сядь или ляг в тишине.",
            "Отключи телефон, не отвлекайся.",
            "Просто будь 5 минут."
        ],
        "pep": "Тишина возвращает ясность после слёз."
    }
]

def format_technique_html(t: dict) -> str:
    lines = []
    lines.append(f"<b>{t['title']}</b>")
    lines.append(f"<i>{t['why']}</i>")
    lines.append("")
    for s in t["steps"]:
        lines.append(f"• {s}")
    lines.append("")
    lines.append(f"✨ <i>{t['pep']}</i>")
    return "\n".join(lines)

# --- Хендлеры ---
async def handle_slezy(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    t = random.choice(TECHNIQUES_SLEZY)
    await update.message.reply_text(
        format_technique_html(t),
        parse_mode=ParseMode.HTML,
        reply_markup=TEARS_FLOW_KB
    )

def setup_tears_block(app: Application) -> None:
    # Обработчики для кнопок «Слёзы» и «Ещё про слёзы»
    app.add_handler(MessageHandler(filters.TEXT & filters.Regex(r"^Слёзы$"), handle_slezy))
    app.add_handler(MessageHandler(filters.TEXT & filters.Regex(r"^Ещё про слёзы$"), handle_slezy))
