# -*- coding: utf-8 -*-
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import Application, MessageHandler, ContextTypes, filters
from telegram.constants import ParseMode
import random

# Клавиатура для подкатегории «Одиночество»
LONELY_FLOW_KB = ReplyKeyboardMarkup(
    [["Ещё про одиночество", "Назад"]],
    resize_keyboard=True
)

# 20 техник для «Одиночество»
TECHNIQUES_LONELY = [
    {
        "title": "Тёплый плед",
        "why": "Физическое тепло снижает чувство покинутости.",
        "steps": [
            "Возьми плед или одеяло.",
            "Закутайся полностью.",
            "Закрой глаза и дыши медленно."
        ],
        "pep": "Твоё тело рядом с тобой, оно уже поддержка."
    },
    {
        "title": "Записка себе",
        "why": "Когда пишешь слова поддержки, слышишь их изнутри.",
        "steps": [
            "Возьми бумагу или блокнот.",
            "Напиши 3 фразы, которые ты хотела бы услышать сейчас.",
            "Прочитай их вслух."
        ],
        "pep": "Ты можешь стать для себя тем голосом, который нужен."
    },
    {
        "title": "Прогулка с вниманием",
        "why": "Помогает почувствовать связь с миром вокруг.",
        "steps": [
            "Выйди на улицу на 10 минут.",
            "Отметь: 3 вещи, которые видишь, 2 — которые слышишь, 1 — которую ощущаешь телом."
        ],
        "pep": "Мир рядом, даже если людей нет рядом."
    },
    {
        "title": "Звонок в прошлое",
        "why": "Напоминание о том, что связь с людьми была и будет.",
        "steps": [
            "Открой фото или письмо близкого человека.",
            "Вспомни момент, когда ты чувствовала тепло и поддержку."
        ],
        "pep": "Эти связи никуда не исчезли, они живут в тебе."
    },
    {
        "title": "Голосовое себе",
        "why": "Свой голос даёт ощущение присутствия.",
        "steps": [
            "Запиши аудио, где говоришь: «Я с тобой. Ты не одна».",
            "Прослушай его сразу или позже."
        ],
        "pep": "Твой голос может стать твоим компасом."
    },
    {
        "title": "Мягкий предмет",
        "why": "Тактильный контакт снижает чувство пустоты.",
        "steps": [
            "Возьми мягкую игрушку, плед или подушку.",
            "Обними её, прижимая к груди."
        ],
        "pep": "Ты можешь дать себе то, что нужно прямо сейчас."
    },
    {
        "title": "Музыка объятий",
        "why": "Звук создаёт иллюзию присутствия рядом.",
        "steps": [
            "Включи любимую музыку.",
            "Ляг или сядь и слушай её 5–10 минут."
        ],
        "pep": "Музыка умеет быть другом."
    },
    {
        "title": "Напоминание на завтра",
        "why": "Создание маленькой цели снижает ощущение пустоты.",
        "steps": [
            "Запиши одно маленькое дело на завтра.",
            "Положи листок на видное место."
        ],
        "pep": "Будущее у тебя есть — шаг за шагом."
    },
    {
        "title": "Онлайн-присутствие",
        "why": "Помогает почувствовать других людей даже на расстоянии.",
        "steps": [
            "Включи видео или подкаст с живым голосом.",
            "Позволь себе слушать, как будто это беседа рядом."
        ],
        "pep": "Даже онлайн-звук может уменьшить пустоту."
    },
    {
        "title": "Окно к миру",
        "why": "Зрительный контакт с движением снимает изоляцию.",
        "steps": [
            "Встань у окна и наблюдай за улицей.",
            "Замечай людей, машины, птиц."
        ],
        "pep": "Ты часть большого мира, он дышит рядом."
    },
    {
        "title": "Список опор",
        "why": "Осознавание поддержек снижает одиночество.",
        "steps": [
            "Напиши список из 5 вещей или людей, которые поддерживали тебя раньше.",
            "Посмотри на этот список и выбери 1 шаг сейчас."
        ],
        "pep": "У тебя уже есть опыт быть не одной."
    },
    {
        "title": "Голос в голове",
        "why": "Представление разговора помогает почувствовать связь.",
        "steps": [
            "Закрой глаза.",
            "Представь, что любимый друг говорит тебе слова поддержки."
        ],
        "pep": "Внутренний друг всегда доступен тебе."
    },
    {
        "title": "Телесное движение",
        "why": "Движение тела уменьшает тяжесть одиночества.",
        "steps": [
            "Включи спокойную музыку.",
            "Медленно подвигай руками и плечами.",
            "Подыши глубоко."
        ],
        "pep": "Твоё тело может стать твоим союзником."
    },
    {
        "title": "Свеча рядом",
        "why": "Огонь создаёт ощущение тепла и присутствия.",
        "steps": [
            "Зажги свечу.",
            "Сядь рядом и наблюдай 3–5 минут."
        ],
        "pep": "Огонь всегда рядом, пока он горит."
    },
    {
        "title": "Записка другу",
        "why": "Даже если не отправить, письмо создаёт ощущение контакта.",
        "steps": [
            "Напиши письмо другу или близкому.",
            "Можешь сохранить или порвать — это твой выбор."
        ],
        "pep": "Ты создаёшь связь словами."
    },
    {
        "title": "Ванна или душ",
        "why": "Тело в воде ощущает границы и защищённость.",
        "steps": [
            "Прими ванну или душ.",
            "Сосредоточься на ощущениях кожи."
        ],
        "pep": "Вода обнимает тебя по-настоящему."
    },
    {
        "title": "Маленькая радость",
        "why": "Дает ощущение заботы о себе.",
        "steps": [
            "Сделай что-то маленькое для себя: чашка чая, сладость, фильм.",
            "Скажи: «Я заслуживаю этого»."
        ],
        "pep": "Ты достойна радости даже в одиночестве."
    },
    {
        "title": "Список благодарности",
        "why": "Направляет фокус на связи и ресурс.",
        "steps": [
            "Напиши 3 вещи, за которые благодарна.",
            "Прочитай их вслух."
        ],
        "pep": "Благодарность соединяет тебя с миром."
    },
    {
        "title": "Письмо будущему",
        "why": "Создаёт ощущение продолжения.",
        "steps": [
            "Напиши письмо себе в будущее: «Через год я…».",
            "Сохрани его."
        ],
        "pep": "Будущее у тебя есть, и оно ждёт."
    },
    {
        "title": "Смотреть в небо",
        "why": "Напоминает о масштабе жизни.",
        "steps": [
            "Выйди на улицу или выгляни в окно.",
            "Посмотри в небо 3 минуты."
        ],
        "pep": "Под этим небом ты никогда не совсем одна."
    }
]

def format_technique_html(t: dict) -> str:
    lines = []
    lines.append(f"<b>{t['title']}</b>")
    lines.append(f"<i>{t['why']}</i>")
    lines.append("")
    for s in t["steps"]:
        lines.append(f"• {s}")
    lines.append("")
    lines.append(f"✨ <i>{t['pep']}</i>")
    return "\n".join(lines)

# --- Хендлеры ---
async def handle_lonely(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    t = random.choice(TECHNIQUES_LONELY)
    await update.message.reply_text(
        format_technique_html(t),
        parse_mode=ParseMode.HTML,
        reply_markup=LONELY_FLOW_KB
    )

def setup_loneliness_block(app: Application) -> None:
    # Обработчики для кнопок «Одиночество» и «Ещё про одиночество»
    app.add_handler(MessageHandler(filters.TEXT & filters.Regex(r"^Одиночество$"), handle_lonely))
    app.add_handler(MessageHandler(filters.TEXT & filters.Regex(r"^Ещё про одиночество$"), handle_lonely))
